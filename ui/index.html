<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text2SQL 智能助手</title>
    <!-- Element Plus 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="style.css?v=6">
</head>

<body>
    <!-- SVG Sprite Definitions -->
    <svg style="display: none;">
        <defs>
            <symbol id="icon-logo" viewBox="0 0 24 24">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" />
            </symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </symbol>
            <symbol id="icon-chat" viewBox="0 0 24 24">
                <path
                    d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 14v-2.47l6.88-6.88c.2-.2.51-.2.71 0l1.77 1.77c.2.2.2.51 0 .71L8.47 14H6zm12 0h-7.5l2-2H18v2z" />
            </symbol>
            <symbol id="icon-time" viewBox="0 0 24 24">
                <path
                    d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
            </symbol>
            <symbol id="icon-book" viewBox="0 0 24 24">
                <path
                    d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z" />
            </symbol>
            <symbol id="icon-school" viewBox="0 0 24 24">
                <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z" />
            </symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24">
                <path
                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
            </symbol>
            <symbol id="icon-bulb" viewBox="0 0 24 24">
                <path
                    d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z" />
            </symbol>
            <symbol id="icon-user" viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </symbol>
            <symbol id="icon-bot" viewBox="0 0 24 24">
                <path
                    d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.38-1 1.72V7h1a3 3 0 0 1 3 3v7a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3v-7a3 3 0 0 1 3-3h1V5.72c-.6-.34-1-.98-1-1.72a2 2 0 0 1 2-2M7.5 13A1.5 1.5 0 0 0 6 14.5 1.5 1.5 0 0 0 7.5 16 1.5 1.5 0 0 0 9 14.5 1.5 1.5 0 0 0 7.5 13m9 0a1.5 1.5 0 0 0-1.5 1.5 1.5 1.5 0 0 0 1.5 1.5 1.5 1.5 0 0 0 1.5-1.5 1.5 1.5 0 0 0-1.5-1.5z" />
            </symbol>
            <symbol id="icon-send" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </symbol>
            <symbol id="icon-table" viewBox="0 0 24 24">
                <path
                    d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 20H4v-4h4v4zm0-6H4v-4h4v4zm0-6H4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4z" />
            </symbol>
            <symbol id="icon-code" viewBox="0 0 24 24">
                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z" />
            </symbol>
            <symbol id="icon-step" viewBox="0 0 24 24">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
            </symbol>
            <symbol id="icon-search" viewBox="0 0 24 24">
                <path
                    d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </symbol>
            <symbol id="icon-recommend" viewBox="0 0 24 24">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </symbol>
        </defs>
    </svg>

    <div id="app">
        <!-- 顶部导航栏 -->
        <header class="top-nav">
            <div class="nav-left">
                <div class="logo-wrapper">
                    <svg class="icon logo-icon">
                        <use xlink:href="#icon-bot"></use>
                    </svg>
                    <span>Text2SQL 助手</span>
                </div>
                <div class="nav-items">
                    <a href="#" class="nav-item active">
                        <svg class="icon">
                            <use xlink:href="#icon-chart"></use>
                        </svg>
                        <span>首页</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg class="icon">
                            <use xlink:href="#icon-code"></use>
                        </svg>
                        <span>建模</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg class="icon">
                            <use xlink:href="#icon-table"></use>
                        </svg>
                        <span>数据库</span>
                    </a>
                </div>
            </div>
            <div class="nav-right">
                <div class="user-profile">
                    <svg class="icon">
                        <use xlink:href="#icon-user"></use>
                    </svg>
                    <span>Admin</span>
                </div>
            </div>
        </header>

        <div class="main-container">
            <!-- 左侧侧边栏 -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">对话历史</span>
                    <el-button type="primary" size="small" @click="resetChat" plain round>
                        <svg class="icon" style="margin-right: 4px;">
                            <use xlink:href="#icon-plus"></use>
                        </svg> New
                    </el-button>
                </div>
                <div class="thread-list">
                    <div class="thread-item active">
                        <svg class="icon thread-icon">
                            <use xlink:href="#icon-chat"></use>
                        </svg>
                        <span class="thread-title">{{ currentThreadTitle || '新对话' }}</span>
                        <span class="thread-time">刚刚</span>
                    </div>
                    <!-- 模拟历史记录 -->
                    <div class="thread-item" v-for="i in 3" :key="i">
                        <svg class="icon thread-icon">
                            <use xlink:href="#icon-time"></use>
                        </svg>
                        <span class="thread-title">历史查询记录 {{ i }}</span>
                        <span class="thread-time">{{ i }}h</span>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="footer-item">
                        <svg class="icon" style="margin-right: 8px;">
                            <use xlink:href="#icon-book"></use>
                        </svg>
                        联想学习
                    </div>
                </div>
            </aside>

            <!-- 主内容区 -->
            <main class="content-area">
                <div class="chat-wrapper" ref="chatWrapper">

                    <!-- 欢迎页 -->
                    <div class="welcome-view" v-if="messages.length === 0">
                        <div class="welcome-header">
                            <div class="card-icon" style="background:transparent; color: var(--primary-color);">
                                <svg class="icon welcome-icon-lg">
                                    <use xlink:href="#icon-bot"></use>
                                </svg>
                            </div>
                            <h2>我想查询什么数据？</h2>
                        </div>

                        <div class="quick-starts">
                            <div class="quick-card" @click="sendMessage('查询北京市所有学校的学生人数')">
                                <div class="card-icon">
                                    <svg class="icon">
                                        <use xlink:href="#icon-school"></use>
                                    </svg>
                                </div>
                                <div class="card-text">查询学校数据</div>
                            </div>
                            <div class="quick-card" @click="sendMessage('分析基础设施指标情况')">
                                <div class="card-icon">
                                    <svg class="icon">
                                        <use xlink:href="#icon-chart"></use>
                                    </svg>
                                </div>
                                <div class="card-text">分析指标数据</div>
                            </div>
                            <div class="quick-card" @click="sendMessage('什么是数字素养')">
                                <div class="card-icon">
                                    <svg class="icon">
                                        <use xlink:href="#icon-bulb"></use>
                                    </svg>
                                </div>
                                <div class="card-text">解释指标定义</div>
                            </div>
                        </div>
                    </div>

                    <!-- 消息列表 -->
                    <div class="message-list" v-else>
                        <div class="message-item" v-for="(msg, index) in messages" :key="index" :class="msg.role">
                            <!-- 用户头像/Bot头像 -->
                            <div class="avatar">
                                <svg class="icon" v-if="msg.role === 'user'">
                                    <use xlink:href="#icon-user"></use>
                                </svg>
                                <svg class="icon" v-else>
                                    <use xlink:href="#icon-bot"></use>
                                </svg>
                            </div>

                            <div class="message-content-wrapper">
                                <!-- 用户提问 -->
                                <div class="user-bubble" v-if="msg.role === 'user'">
                                    {{ msg.content }}
                                </div>

                                <!-- Bot 回答 -->
                                <div class="bot-response" :class="{ 'is-streaming': msg.isStreaming }">

                                    <!-- 思考步骤 (折叠面板) -->
                                    <div class="reasoning-steps" v-if="msg.steps">
                                        <el-collapse>
                                            <el-collapse-item name="1">
                                                <template #title>
                                                    <div style="display:flex;align-items:center;gap:6px;">
                                                        <svg class="icon" style="color:var(--primary-color)">
                                                            <use xlink:href="#icon-step"></use>
                                                        </svg>
                                                        <span>思考过程</span>
                                                    </div>
                                                </template>
                                                <el-steps direction="vertical" :active="msg.steps.length"
                                                    finish-status="success">
                                                    <el-step v-for="(step, sIdx) in msg.steps" :key="sIdx"
                                                        :title="step.title" :description="step.desc"></el-step>
                                                </el-steps>
                                            </el-collapse-item>
                                        </el-collapse>
                                    </div>

                                    <!-- 查询规划推理 (Query Reasoning) -->
                                    <div class="ai-reasoning" v-if="msg.reasoning"
                                        style="margin: 12px 0; padding: 12px; border-left: 4px solid #409eff; background: #ecf5ff; border-radius: 4px;">
                                        <div
                                            style="font-size: 13px; font-weight: bold; color: #409eff; margin-bottom: 6px; display: flex; align-items: center; gap: 4px;">
                                            <svg class="icon" style="width:14px; height:14px; color:#409eff;">
                                                <use xlink:href="#icon-step"></use>
                                            </svg>
                                            查询执行规划：
                                        </div>
                                        <div style="font-size: 13px; color: #666; white-space: pre-wrap;">
                                            {{ msg.reasoning }}
                                        </div>
                                    </div>

                                    <!-- AI 反思/ReAct Thought -->

                                    <div class="ai-reflection" v-if="msg.reflection"
                                        style="margin: 12px 0; padding: 12px; border-left: 4px solid #e6a23c; background: #fdf6ec; border-radius: 4px;">
                                        <div
                                            style="font-size: 13px; font-weight: bold; color: #e6a23c; margin-bottom: 6px; display: flex; align-items: center; gap: 4px;">
                                            <i class="el-icon-warning-outline"></i>
                                            <svg class="icon" style="width:14px; height:14px;">
                                                <use xlink:href="#icon-correct"></use>
                                            </svg>
                                            AI 执行反思：
                                        </div>
                                        <div style="font-size: 13px; color: #666; font-style: italic;">
                                            {{ msg.reflection }}
                                        </div>
                                    </div>

                                    <!-- 文本回答 -->
                                    <div class="response-text" v-html="formatMarkdown(msg.content)"></div>


                                    <!-- 数据表格 (如果有 SQL 结果) -->
                                    <!-- 数据结果按钮 -->
                                    <div class="data-result-btn" v-if="msg.sqlResult && msg.sqlResult.length > 0"
                                        style="margin-top: 10px;">
                                        <el-button type="success" plain size="small" @click="showData(msg.sqlResult)">
                                            <svg class="icon" style="margin-right:4px">
                                                <use xlink:href="#icon-table"></use>
                                            </svg>
                                            查看查询数据 ({{ msg.sqlResult.length }} 条)
                                        </el-button>
                                    </div>

                                    <!-- SQL 代码 (折叠) -->
                                    <div class="sql-code" v-if="msg.sql">
                                        <el-collapse>
                                            <el-collapse-item name="2">
                                                <template #title>
                                                    <div style="display:flex;align-items:center;gap:6px;">
                                                        <svg class="icon">
                                                            <use xlink:href="#icon-code"></use>
                                                        </svg>
                                                        <span>查看 SQL</span>
                                                    </div>
                                                </template>
                                                <pre>{{ msg.sql }}</pre>
                                            </el-collapse-item>
                                        </el-collapse>
                                    </div>

                                    <!-- 相关推荐问题 -->
                                    <div class="suggested-questions" v-if="index === messages.length - 1">
                                        <div class="suggest-title">
                                            <svg class="icon">
                                                <use xlink:href="#icon-recommend"></use>
                                            </svg>
                                            推荐问题
                                        </div>
                                        <div class="question-chips">
                                            <el-tag v-for="q in suggestedQuestions" :key="q" type="info" effect="plain"
                                                class="question-tag" @click="sendMessage(q)">
                                                {{ q }}
                                            </el-tag>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 加载中 -->
                        <div class="message-item assistant" v-if="isLoading">
                            <div class="avatar"><svg class="icon">
                                    <use xlink:href="#icon-bot"></use>
                                </svg></div>
                            <div class="message-content-wrapper">
                                <div class="bot-response">
                                    <div class="loading-dots">
                                        <span></span><span></span><span></span>
                                    </div>
                                    <span style="font-size: 12px; color: #909399; margin-left: 10px">思考中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部输入框 -->
                <div class="input-area">
                    <div class="input-container">
                        <el-input type="textarea" :autosize="{ minRows: 1, maxRows: 4}" placeholder="询问任何问题以探索您的数据..."
                            v-model="inputMessage" @keydown.enter.native.prevent="handleEnter" resize="none">
                        </el-input>
                        <el-button type="primary" class="send-btn" @click="handleSend" :loading="isLoading">
                            <svg class="icon" v-if="!isLoading" style="font-size:16px">
                                <use xlink:href="#icon-send"></use>
                            </svg>
                        </el-button>
                    </div>
                    <div class="input-footer">
                        AI 生成的内容可能不准确，请核实重要信息
                    </div>
                </div>
            </main>
            </main>
        </div>

        <!-- 数据展示弹窗 -->
        <el-dialog v-model="dialogVisible" title="查询数据详情" width="80%">
            <el-table :data="tableData" border stripe style="width: 100%" height="500">
                <el-table-column v-for="(val, key) in (tableData.length > 0 ? tableData[0] : {})" :key="key" :prop="key"
                    :label="key" min-width="120" show-overflow-tooltip>
                </el-table-column>
            </el-table>
        </el-dialog>
    </div>

    <!-- 引入 Vue 3 和 Element Plus JS -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- 脚本 -->
    <script src="/ui/script.js?v=8"></script>
</body>

</html>